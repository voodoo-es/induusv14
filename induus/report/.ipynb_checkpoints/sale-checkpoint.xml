<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_saleorder_document" inherit_id="sale.report_saleorder_document">
        <xpath expr="//table" position="attributes">
            <attribute name="class" add="table-center" separator=" "/>
        </xpath>

        <xpath expr="//table[1]/thead[1]/tr[1]/th[5]" position="replace"/>
        <xpath expr="//table[1]/tbody//tr[1]//td[5]" position="replace"/>

        <xpath expr="/t[1]/t[1]/div[1]/div[3]/div[1]/div[1]/table[1]/t[1]" position="attributes">
            <attribute name="t-if">(env.context.get('proforma', False) or is_pro_forma)</attribute>
        </xpath>
        <xpath expr="/t[1]/t[1]/div[1]/div[3]/div[1]/div[1]/table[1]/tr[2]" position="attributes">
            <attribute name="t-if">(env.context.get('proforma', False) or is_pro_forma)</attribute>
        </xpath>

        <xpath expr="/t/t/div/div[3]/div/div/table/tr/td[1]" position="attributes">
            <attribute name="style" separator=";" add="background-color:#FFFFFF"/>
            <attribute name="style" separator=";" add="color:#000000"/>
        </xpath>

        <xpath expr="/t/t/div/div[3]/div/div/table/tr/td[2]" position="attributes">
            <attribute name="style" separator=";" add="color:#000000"/>
            <attribute name="style" separator=";" add="background-color:#FFFFFF"/>
        </xpath>

        <xpath expr="//h2[1]" position="attributes">
            <attribute name="class">mt-3</attribute>
        </xpath>
        
        <xpath expr="//div[@t-field='doc.partner_id']" position="before">
            <strong>Cliente:</strong>
        </xpath>

        <xpath expr="//t[@t-set='address']//p" position="after">
            <div t-if="doc.user_id.name">
                <p><strong>Comercial:</strong>
                    <br t-field="doc.user_id.name"/>
                    <br t-field="doc.user_id.email"/>
                </p>
            </div>
        </xpath>

        <xpath expr="/t[1]/t[1]/div[1]/div[2]/div[4]" position="replace"/>
        
        <xpath expr="/t[1]/t[1]/div[1]/div[2]/div[4]" position="replace">
            <div t-if="doc.validity_date and doc.carrier_id" class="col-auto mw-100 mb-2">
                <strong>Transporte:</strong>
                <p class="m-0" t-field="doc.carrier_id.name"/>
            </div>
            
            <div t-if="doc.client_order_ref" class="col-auto mw-100 mb-2">
                <strong>Your Reference:</strong>
                <p class="m-0" t-field="doc.client_order_ref"/>
            </div>
        </xpath>
        
        <xpath expr="//div[@id='informations'][1]/div[@t-if='doc.client_order_ref']" position="replace"/>
        
        <xpath expr="//span[@t-field='line.name'][1]" position="replace">
            <pre t-raw='line.name.replace("[%s]" % line.product_id.default_code, "").replace("[%s]" % line.referencia_cliente, "").strip()'
                 style="font-family:inherit;font-size:inherit;color:inherit;margin-bottom:0;white-space:inherit;overflow:hidden;"/>
        </xpath>

        <xpath expr="//table[hasclass('o_main_table')]" position="before">
            <div t-if="doc.es_proyecto" class="mt32 mb32" id="proyectos">
                <div class="row">
                    <div class="col-12 text-center" style="margin-bottom:30px" t-if="doc.proyecto_titulo">
                        <span style="font-size:1.3em;font-weight:bold;" t-field="doc.proyecto_titulo"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12" style="margin-bottom:30px" t-if="doc.editor_proyecto">
                        <span t-field="doc.editor_proyecto"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12" t-if="doc.precio_venta_proyecto_detalle">
                        <div class="clearfix">
                            <div t-attf-class="#{'col-4' if report_type != 'html' else 'col-sm-7 col-md-5'} ml-auto">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr class="border-black o_total" style="background-color:#495057;color:#ffffff;">
                                            <td style="border-top:none!important;"><strong>Total del proyecto</strong></td>
                                            <td style="border-top:none!important;" class="text-right">
                                                <span t-field="doc.precio_venta_proyecto_detalle"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//td[@name='td_priceunit']" position="attributes">
            <attribute name="width">130</attribute>
        </xpath>
        
        <xpath expr="//table[hasclass('o_main_table')]" position="attributes">
            <attribute name="t-if">doc.order_line and not doc.es_proyecto</attribute>
        </xpath>

        <xpath expr="//div[@id='total']" position="attributes">
            <attribute name="t-if">doc.order_line and not doc.es_proyecto</attribute>
        </xpath>

        <xpath expr="//table[1]/thead[1]/tr[1]/th[2]" position="after">
            <th class="text-center" width="150">
                <t t-if="doc.state == 'sale'">
                    Entrega prevista
                </t>
                <t t-else="">
                    Tiempo entrega
                </t>
            </th>
        </xpath>

        <xpath expr="//tbody[hasclass('sale_tbody')]//tr//td[2]" position="after">
            <td class="text-center">
                <t t-if="doc.state == 'sale'">
                    <span t-field="line.fecha_prevista" t-options='{"widget": "date"}'/>
                </t>
                <t t-else="">
                    <span t-esc="int(line.customer_lead)"/> días
                </t>
            </td>
        </xpath>

        <xpath expr="//p[@id='fiscal_position_remark']" position="before">
            <div class="mt16" t-if="doc.equipo_id">
                <div class="row">
                    <div class="col-12">
                        <h5 class="mb0">Equipo</h5>
                        <t t-esc="doc.equipo_id.descripcion"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-auto">
                        <strong>Serie:</strong> <t t-esc="doc.equipo_id.serie"/> <br/>
                        <strong>Serial:</strong> <t t-esc="doc.equipo_id.serial"/>
                    </div>
                    <div class="col-auto">
                        <strong>Referencia:</strong> <t t-esc="doc.equipo_id.referencia"/><br/>
                        <strong>EME:</strong> <t t-esc="doc.equipo_id.eme"/>
                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//p[@id='fiscal_position_remark']/strong[1]" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>

        <xpath expr="//tr[hasclass('o_subtotal')]/td[1]/strong" position="replace">
            <strong>Base imponible</strong>
        </xpath>

        <xpath expr="//tr[hasclass('o_subtotal')]" position="after">
            <t t-if="not (env.context.get('proforma', False) or is_pro_forma)">
                <t t-foreach="doc.amount_by_group" t-as="amount_by_group">
                    <tr style="">
                        <t t-if="amount_by_group[3] == 1 and doc.amount_untaxed == amount_by_group[2]">
                            <td>
                                <span t-esc="amount_by_group[0]"/>
                                <span>&amp;nbsp;<span>on</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/></span>
                            </td>
                            <td class="text-right o_price_total">
                                <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                            </td>
                        </t>
                        <t t-else="">
                            <td>
                                <span t-esc="amount_by_group[0]"/>
                            </td>
                            <td class="text-right o_price_total">
                                <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                            </td>
                        </t>
                    </tr>
                </t>
                <tr class="border-black o_total">
                    <td style="border-right:0;">
                        <strong>Total</strong>
                    </td>
                    <td class="text-right">
                        <span t-field="doc.amount_total"/>
                    </td>
                </tr>
            </t>
        </xpath>

        <xpath expr="//p[@t-field='doc.date_order']" position="attributes">
            <attribute name="t-options-widget">"date"</attribute>
        </xpath>

        <xpath expr="//table[1]/tbody[1]//tr[1]/t[1]/td[4]/span[1]" position="attributes">
            <attribute name="t-options-widget">"monetary"</attribute>
        </xpath>

        <xpath expr="//span[@t-field='line.discount']" position="after">
            %
        </xpath>

        <xpath expr="//p[@t-if='doc.payment_term_id.note']" position="replace">
            <p t-if="doc.payment_term_id.note" style="margin-bottom:0;padding-bottom:0;">
                <b>Condiciones de pago: </b>
                <span t-field="doc.payment_term_id.note"/>
            </p>
        </xpath>

        <xpath expr="/t[1]/t[1]/div[1]/div[2]/div[2]/p[1]" position="attributes">
            <attribute name="t-options-widget">"date"</attribute>
        </xpath>

        <xpath expr="//table[hasclass('o_main_table')]" position="attributes">
            <attribute name="class" add="o_bg_gris" separator=" "/>
        </xpath>
        
        <xpath expr="//table[1]/thead[1]/tr[1]/th[1]" position="after">
            <th class="text-center">Código/Peso</th>
        </xpath>

        <xpath expr="//th[@name='th_description']" position="replace">
            <th name="th_description" class="text-center">
                <t t-set="mostrar_ref" t-value="False"/>
                <t t-if="doc.mostrar_ref_induus">
                    Ref Induus/Descripción
                    <t t-set="mostrar_ref" t-value="True"/>
                </t>
                <t t-if="not doc.mostrar_ref_induus and not doc.no_mostrar_ref">
                    Referencia/Descripción
                    <t t-set="mostrar_ref" t-value="True"/>
                </t>
                <t t-if="not mostrar_ref">
                    Descripción
                </t>
            </th>
        </xpath>
        
        <xpath expr="//table[1]/thead[1]/tr[1]/th[1]" position="before">
            <th class="text-center">Pos.</th>
        </xpath>

        <xpath expr="//tbody[hasclass('sale_tbody')]//tr//td[1]" position="after">
            <td class="text-center">
                <span t-field="line.product_id.intrastat_id.code"/> / <span t-field="line.product_id.weight"/> kg
            </td>
        </xpath>
        
        <xpath expr="//td[@name='td_name']" position="replace">
            <td name="td_name" class="text-center">
                <t t-set="ref_string" t-value="''"/>
                <t t-if="not doc.mostrar_ref_induus and not doc.no_mostrar_ref">
                    <strong><span t-field="line.referencia_cliente"/></strong> <br/>
                    <t t-set="ref_string" t-value="'[%s]' % line.referencia_cliente"/>
                </t>
                <t t-if="doc.mostrar_ref_induus">
                    <strong><span t-field="line.product_id.default_code"/></strong> <br/>
                    <t t-set="ref_string" t-value="'[%s]' % line.product_id.default_code"/>
                </t>
                <t t-if="line.name" t-esc="line.name.replace(ref_string, '')"/>
            </td>
        </xpath>
        
        <xpath expr="//tbody[hasclass('sale_tbody')]//tr//td[1]" position="before">
            <td style="background-color:#e9ecef;"><t t-esc="line_index + 1"/></td>
        </xpath>
    </template>

    <template id="report_sale_payment_mode" inherit_id="account_payment_sale.report_sale_payment_mode">
        <xpath expr="//p[@id='payment_mode_note']" position="replace">
            <p t-if="doc.payment_mode_id.note" id="payment_mode_note" style="margin-bottom:0; padding-bottom:0;">
                <strong>Forma de pago:</strong>
                <span t-field="doc.payment_mode_id.name"/>
            </p>
            
            <p t-if="doc.payment_mode_id.fixed_journal_id.bank_account_id" id="payment_mode_acc_number" style="margin-bottom:0; padding-bottom:0;">
                <strong>Cuenta bancaria:</strong>
                <span t-field="doc.payment_mode_id.fixed_journal_id.bank_account_id.acc_number"/>
            </p>
            
            <p t-if="doc.payment_mode_id.fixed_journal_id.bank_id.bic" id="payment_mode_bic" style="margin-bottom:0; padding-bottom:0;">
                <strong>BIC/SWIFT:</strong>
                <span t-field="doc.payment_mode_id.fixed_journal_id.bank_id.bic"/>
            </p>
            
            <t t-if="doc.fiscal_position_id and doc.fiscal_position_id.sudo().note2">
                <p style="margin-bottom:0; padding-bottom:0;">
                    <t t-raw="doc.fiscal_position_id.sudo().note2"/>
                </p>
            </t>
            <t t-if="doc.fiscal_position_id and doc.payment_mode_id">
                <t t-set="payment_mode" t-value="doc.fiscal_position_id.modo_pago(doc.payment_mode_id.id)"/>
                <t t-if="payment_mode">
                    <p style="margin-bottom:0; padding-bottom:0;">
                        <span t-if="payment_mode" t-raw="payment_mode"/>
                    </p>
                </t>
            </t>
            <p></p>
        </xpath>
    </template>

    <template id="report_saleorder_proyecto_document">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-set="o" t-value="doc.with_context(lang=doc.partner_id.lang)" />
                <t t-set="partner" t-value="o.partner_id or (o.move_lines and o.move_lines[0].partner_id) or False"/>
                <t t-if="partner" name="partner_header">
                    <t t-set="address">
                        <div t-esc="partner"
                             t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'/>
                    </t>
                </t>

                <div class="page">
                    <h2 class="mt-3">
                        <t t-foreach="o.picking_ids.filtered(lambda x: x.picking_type_id.code == 'outgoing')" t-as="picking"><t t-if="picking_index > 0">, </t><span t-field="picking.name"/></t>
                    </h2>
                    <table class="table table-sm o_bg_gris">
                        <thead>
                            <tr>
                                <th class="text-center"><strong>ORDEN</strong></th>
                                <th class="text-center"><strong>REFERENCIA CLIENTE</strong></th>
                                <th class="text-center"><strong>FECHA</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="text-center"><span t-field="o.name"/></td>
                                <td class="text-center"><span t-field="o.client_order_ref"/></td>
                                <td class="text-center"><span t-field="o.date_order"/></td>
                            </tr>
                        </tbody>
                    </table>

                    <table class="mt48 table table-sm o_bg_gris">
                        <thead>
                            <tr>
                                <th style="min-width:100px;" class="text-center"><strong>R. CLIENTE</strong></th>
                                <th class="text-center"><strong>PRODUCTO</strong></th>
                                <th class="text-center"><strong>CANTIDAD PEDIDA</strong></th>
                                <th class="text-center"><strong>CANTIDAD ENTREGADA</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="doc.order_line" t-as="line">
                                <td class="text-center">
                                    <t t-set="ref_cliente" t-value="''"/>
                                    <t t-if="o.partner_id">
                                        <t t-set="ref_cliente" t-value="line.product_id.product_tmpl_id.referencia_cliente(o.partner_id)"/>
                                    </t>
                                    <t t-if="not ref_cliente">
                                        <t t-set="ref_cliente" t-value="line.product_id.default_code"/>
                                    </t>
                                    <t t-esc="ref_cliente"/>
                                </td>
                                <td class="text-center">
                                    <span t-field="line.product_id.name"/>
                                </td>
                                <td class="text-center">
                                    <sapn t-field="line.product_uom_qty"/>
                                </td>
                                <td class="text-center">
                                    <sapn t-field="line.qty_delivered"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </t>
        </t>
    </template>

    <template id="report_saleorder_proyecto">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="induus.report_saleorder_proyecto_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <report id="action_report_saleorder_proyecto"
            string="Entrega proyecto"
            model="sale.order"
            report_type="qweb-pdf"
            file="induus.report_saleorder_proyecto"
            name="induus.report_saleorder_proyecto"
            print_report_name="'Entrega - %s' % object.name"
        />
</odoo>
